---
title: "Streamlit Elements ã‚’ä½¿ã£ã¦ãƒ‰ãƒ©ãƒƒã‚°ãƒ»ã‚µã‚¤ã‚ºå¤‰æ›´å¯èƒ½ãªãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’ä½œã£ã¦ã¿ãŸ" # è¨˜äº‹ã®ã‚¿ã‚¤ãƒˆãƒ«
emoji: "ğŸ“ˆ" # ã‚¢ã‚¤ã‚­ãƒ£ãƒƒãƒã¨ã—ã¦ä½¿ã‚ã‚Œã‚‹çµµæ–‡å­—ï¼ˆ1æ–‡å­—ã ã‘ï¼‰
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢è¨˜äº‹
topics: # ã‚¿ã‚°ã€‚["markdown", "rust", "aws"]ã®ã‚ˆã†ã«æŒ‡å®šã™ã‚‹
  - "python"
  - "streamlit"
  - "mui"
  - "nivo"
published: true # å…¬é–‹è¨­å®šï¼ˆfalseã«ã™ã‚‹ã¨ä¸‹æ›¸ãï¼‰
published_at: "2023-12-08 18:30" # å…¬é–‹è¨­å®šæ—¥æ™‚ï¼ˆJSTï¼‰
---

ã“ã®è¨˜äº‹ã¯ã€[Retty Advent Calendar 2023](https://adventar.org/calendars/9061)ã€7æ—¥ç›®ã®è¨˜äº‹ã§ã™ğŸ„ğŸ (1æ—¥é…ã‚Œã¦ã®æŠ•ç¨¿ã§ã™ > <)
![](https://storage.googleapis.com/zenn-user-upload/71e401c2cb46-20231208.png =350x)

# ã‚µãƒãƒª
- [streamlit-elements](https://github.com/okld/streamlit-elements)ã‚’ä½¿ã†ã¨ã€ãƒ‰ãƒ©ãƒƒã‚°ãƒ»ã‚µã‚¤ã‚ºå¤‰æ›å¯èƒ½ãªãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’ä½œã‚‹ã“ã¨ãŒã§ãã‚‹
- Streamlitã ã¨ã€ãƒ‡ãƒ¼ã‚¿ã®é›†è¨ˆå¯¾è±¡ã®çµã‚Šè¾¼ã¿ãƒ»è¡¨ç¤º/éè¡¨ç¤ºã®å‡ºã—åˆ†ã‘ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚‚è¡Œã„ã‚„ã™ã„
- å®Ÿè£…ã—ãŸæŒ™å‹•ã¯ã“ã‚“ãªæ„Ÿã˜â†“![](https://storage.googleapis.com/zenn-user-upload/44bd5ca0166e-20231208.gif)*å®Ÿéš›ã®æŒ™å‹•*
â€»æœ¬è¨˜äº‹ã®ç´°ã‹ã„å®Ÿè£…å†…å®¹ã¯[https://github.com/Igecchi/bq_streamlit/](https://github.com/Igecchi/bq_streamlit/)ã‚’ã”å‚ç…§ãã ã•ã„

- â†“è©¦ã›ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸï¼ â€»ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€ä¸€éƒ¨è¡¨ç¤ºå´©ã‚ŒãŒã‚ã‚Šã¾ã™mm
[ğŸ“Šã“ã¡ã‚‰ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ğŸ“Š](https://draggable-resizable-dashboard-igeta-test.streamlit.app/)

# Streamlitã¨ã¯?
[Streamlit](https://streamlit.io/)ã¯ã€Pythonã§å®Ÿè£…ã•ã‚ŒãŸã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ã®Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã™ã€‚
ã“ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’ä½¿ã†ã“ã¨ã§ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®çµŒé¨“ãŒãªãã¨ã‚‚Pythonã®ã¿ã§ã€æ©Ÿæ¢°å­¦ç¿’ã‚„ãƒ‡ãƒ¼ã‚¿ã®å¯è¦–åŒ–ã‚’è¡Œã£ãŸWebã‚¢ãƒ—ãƒªã‚’ä½œæˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ç›´è¿‘ã§ã¯ã€Snowflakeä¸Šã§Streamlitã‚¢ãƒ—ãƒªã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã€å°è€³ã«ã¯ã•ã‚€æ©Ÿä¼šã‚‚å¢—ãˆã¦ã„ã¾ã™ã€‚

ãªãŠStreamlitã®åŸºæœ¬çš„ãªä½¿ã„æ–¹ã«é–¢ã—ã¦ã¯ã€ä»–ã®è¨˜äº‹ã‚’æ¢ã—ã¦ã¿ã¦ãã ã•ã„ï¼

[å‚è€ƒã«ãªã‚Šãã†ãªè¨˜äº‹]
ãƒ»[30 Days of Streamlit](https://30days.streamlit.app/)
ãƒ»[Streamlitå…¥é–€ï¼‹å¿œç”¨ ï½ ãƒ‡ãƒ¼ã‚¿åˆ†æWebã‚¢ãƒ—ãƒªã‚’çˆ†é€Ÿã§é–‹ç™ºã™ã‚‹](https://qiita.com/tamura__246/items/366b5581c03dd74f4508)
ãƒ»[Streamlit documentation(å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ)](https://docs.streamlit.io/)
ãƒ»[Streamlit | Snowflake Documentation](https://docs.snowflake.com/ja/developer-guide/native-apps/adding-streamlit)

# ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™
ã¾ãšã¯ã€Streamlitã‚¢ãƒ—ãƒªã§ãƒãƒ£ãƒ¼ãƒˆä½œæˆã™ã‚‹ãŸã‚ã«å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã®æº–å‚™ã‹ã‚‰é€²ã‚ã¦ã„ãã¾ã™ã€‚

## ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã®ç”¨æ„
ä»Šå›ã¯ã€BigQueryã®å…¬é–‹ãƒ‡ãƒ¼ã‚¿ã§ã‚ã‚‹covid19_open_dataã‚’çµã‚Šè¾¼ã‚“ã§åˆ©ç”¨ã—ã¾ã—ãŸã€‚
éƒ½åº¦BQã«ã‚¯ã‚¨ãƒªç™ºè¡Œã—ãŸããªã‹ã£ãŸãŸã‚ã€æ—¥æœ¬ã®ãƒ‡ãƒ¼ã‚¿ã«çµã‚Šè¾¼ã¿csvã¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šè¾¼ã¿ã¾ã—ãŸã€‚ï¼ˆæŠ½å‡ºã—ãŸãƒ‡ãƒ¼ã‚¿ã¯[ã“ã¡ã‚‰](https://github.com/Igecchi/bq_streamlit/blob/42a8a25c6c298fabee055bf7adf3606f82f77e10/data/test_covid19_analysis_japan.csv)ã‹ã‚‰DLã§ãã¾ã™ã€‚ï¼‰

ã¡ãªã¿ã«ãƒ‡ãƒ¼ã‚¿å–å¾—ã«ç”¨ã„ãŸã‚¯ã‚¨ãƒªã¯ä¸‹è¨˜ã§ã™â†“
```sql
select
  date
  , location_key
  , country_name
  , subregion1_name
  , subregion2_name
  , population
  , population_male
  , population_female
  , cumulative_confirmed
  , cumulative_deceased
  , cumulative_recovered
from `bigquery-public-data.covid19_open_data.covid19_open_data`
where country_name = 'Japan'
```

# å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

streamlitãŠã‚ˆã³ã€ä»Šå›åˆ©ç”¨ã™ã‚‹[streamlit-elements](https://pypi.org/project/streamlit-elements/)ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
è‡ªåˆ†ã®ç’°å¢ƒã§ã¯ã€ä¸‹è¨˜ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’åˆ©ç”¨ã—ã¾ã—ãŸã€‚ï¼ˆâ€»Pythonã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯3.10.10ï¼‰
```
pip install streamlit==1.27
pip install streamlit-elements==0.1
```

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ä½œæˆ
## ãƒ•ã‚©ãƒ«ãƒ€æ§‹æˆ

é–‹ç™ºã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’è¨˜è¼‰ã™ã‚‹`streamlit_app.py`ã¨ã€èª­ã¿è¾¼ã‚€ãƒ‡ãƒ¼ã‚¿ã‚’æ ¼ç´ã—ã¦ã„ã‚‹`data/test_covid19_analysis_japan.csv`ã‹ã‚‰æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ã€‚
â€»ãƒ•ã‚¡ã‚¤ãƒ«åã¯ä»»æ„ã®ã‚‚ã®ã‚’è¨­å®šå¯èƒ½ã§ã™ã€‚
```
streamlit_app.py
data
 â””â”€ test_covid19_analysis_japan.csv
```

## ã‚³ãƒ¼ãƒ‰ã®å®Ÿè£…
å®Ÿè£…ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã®å…¨ä½“åƒã¯ä¸‹è¨˜ã¨ãªã‚Šã¾ã™ã€‚
:::details ã‚³ãƒ¼ãƒ‰ã®å…¨ä½“åƒ
```py:streamlit_app.py
## ----- Import Library(å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ) ----- ##
import pandas as pd
import streamlit as st
from datetime import datetime
from streamlit_elements import elements, dashboard, mui, nivo
from streamlit_elements import dashboard

## ----- Load Data & Processï¼ˆãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã¨åŠ å·¥ï¼‰----- ##
# Read csv fileï¼ˆcsvã®èª­ã¿è¾¼ã¿ï¼‰
df = pd.read_csv('data/test_covid19_analysis_japan.csv', index_col=0)
df_dataset = df.reset_index(drop=True) # Reset indexï¼ˆindexã®æŒ¯ã‚Šç›´ã—ï¼‰

# Filter dataset by Japan and extract prefecture name list
# ï¼ˆãƒ‡ãƒ¼ã‚¿ã‚’æ—¥æœ¬ã«çµã‚Šè¾¼ã¿ã€éƒ½é“åºœçœŒãƒªã‚¹ãƒˆã‚’æŠ½å‡ºã™ã‚‹ï¼‰
df_dataset = df_dataset[(df_dataset['country_name']=='Japan')]
df_dataset = df_dataset.rename({'subregion1_name': 'prefecture_name'}, axis='columns')
prefecture_name_list = df_dataset['prefecture_name'].unique()
column_list = df_dataset.columns.to_list()

## Fill NaN with 0ï¼ˆnullå€¤ã‚’0åŸ‹ã‚ã™ã‚‹ï¼‰
df_dataset = df_dataset.fillna(0)
df_dataset_all = df_dataset.copy()


## ----- Sidebarï¼ˆã‚µã‚¤ãƒ‰ãƒãƒ¼ã®è¨­å®šï¼‰ ----- ##
## --- Input boxï¼ˆãƒ‡ãƒ¼ã‚¿çµã‚Šè¾¼ã¿ç”¨ã®å…¥åŠ›æ¬„ã®ä½œæˆï¼‰ --- ##
## Input box of prefecture_nameï¼ˆè¤‡æ•°éƒ½é“åºœçœŒã§çµã‚Šè¾¼ã¿ã‚’è¡Œã†ãŸã‚ã®å…¥åŠ›Boxã®ä½œæˆï¼‰
prefecture_name = st.sidebar.multiselect(
    'Prefecutre Name'
    , prefecture_name_list
    , default=['Tokyo']
    )

## Input box of Start dayï¼ˆé›†è¨ˆæœŸé–“ã®èµ·ç‚¹ã¨ãªã‚‹æ—¥ä»˜ï¼‰
start_date = pd.to_datetime(st.sidebar.date_input('Start date', datetime(2020, 3, 1)))

## Input box of End dayï¼ˆé›†è¨ˆæœŸé–“ã®çµ‚ç‚¹ã¨ãªã‚‹æ—¥ä»˜ï¼‰
end_date = pd.to_datetime(st.sidebar.date_input('End date', datetime(2021, 12, 31)))
st.sidebar.write('------------------')

## --- Check boxï¼ˆã‚°ãƒ©ãƒ•ãƒ»è¡¨ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’å‡ºã—åˆ†ã‘ã‚‹ãŸã‚ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ä½œæˆï¼‰ --- ##
st.sidebar.write('Graph Check Box')
is_graph_active_confirmed = st.sidebar.checkbox('Show Confirmed Graph', value=True)
is_graph_active_deceased = st.sidebar.checkbox('Show Deceased Graph', value=True)
# is_graph_active_recovered = st.sidebar.checkbox('Show Recovered Graph', value=True)
# is_graph_active_pupulation = st.sidebar.checkbox('Show Pupulation Graph', value=True)
is_graph_active_male_pupulation = st.sidebar.checkbox('Show Male Pupulation Graph', value=True)
is_graph_active_female_pupulation = st.sidebar.checkbox('Show Female Pupulation Graph', value=True)

st.sidebar.write('------------------')
st.sidebar.write('Table Column Check Box')
is_table_active = st.sidebar.checkbox('Show Table', value=True)
column_list = st.sidebar.multiselect(
    'Show Table'
    , column_list
    , default=['country_name', 'prefecture_name', 'population', 'population_male', 'population_female', 'cumulative_confirmed', 'cumulative_deceased', 'cumulative_recovered']
    )

## ----- Dataset processingï¼ˆãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®åŠ å·¥ãƒ»çµã‚Šè¾¼ã¿ï¼‰ ----- ##
## -------- Dataset processingï¼ˆãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®åŠ å·¥ãƒ»çµã‚Šè¾¼ã¿ï¼‰ -------- ##
df_dataset['date'] = pd.to_datetime(df_dataset['date'])
# Filter dataset by first day of monthï¼ˆæœˆåˆæ—¥ã®ã¿æŠ½å‡ºï¼‰
df_dataset = df_dataset[(df_dataset['date'].dt.day == 1)]
## Filter dataset by selected prefecture_name&termï¼ˆã‚µã‚¤ãƒ‰ãƒãƒ¼ã§é¸æŠã•ã‚ŒãŸéƒ½é“åºœçœŒãƒ»é›†è¨ˆæœŸé–“ã«çµã‚Šè¾¼ã¿ï¼‰
df_dataset = df_dataset[(df_dataset['prefecture_name'].isin(prefecture_name)) & (df_dataset['date'] >= start_date) & (df_dataset['date'] <= end_date)]
# Change date type to strï¼ˆæ—¥ä»˜å‹ã ã¨æƒ³å®šé€šã‚Šã®å¯è¦–åŒ–ãŒã§ããªã‹ã£ãŸãŸã‚ã€æ–‡å­—åˆ—å‹ã«å¤‰æ›ï¼‰
df_dataset['date'] = df_dataset['date'].astype(str)

## duplicate dataset 1.for graph, 2.for table
df_dataset_graph = df_dataset.copy()
df_dataset_table = df_dataset.copy()

### -------- Graph Visualization settingï¼ˆã‚°ãƒ©ãƒ•ã®å¯è¦–åŒ–ã‚’è¡Œã†ãŸã‚ã®è¨­å®šï¼‰ -------- ###
tmp = df_dataset_graph.groupby(['date']).sum()[['cumulative_confirmed']]
tmp['date'] = tmp.index
tmp = tmp.rename(columns={'date': 'x', 'cumulative_confirmed': 'y'})[['x', 'y']].to_json(orient='records')
tmp_data = [
        {
            "id": prefecture_name,
            "data": eval(tmp)
        }
    ]

## If you want to show detail data, you can use this code.
# st.write(tmp_data)

def create_data(y_data):
    tmp = df_dataset_graph.groupby(['date']).sum()[[y_data]]
    tmp['date'] = tmp.index
    tmp = tmp.rename(columns={'date': 'x', y_data: 'y'})[['x', 'y']].to_json(orient='records')
    return [
                {
                    "id": "+".join(prefecture_name),
                    "data": eval(tmp)
                }
            ]

def create_chart(KEYNAME, CARD_TITLE, INPUT_DATA):
    with mui.Card(key=KEYNAME, sx={"display": "flex", "flexDirection": "column"}):
                mui.CardHeader(title=CARD_TITLE, className="draggable")
                with mui.CardContent(sx={"flex": 1, "minHeight": 0}):
                    nivo.Line(
                        data=INPUT_DATA,
                        margin={ 'top': 10, 'right': 80, 'bottom': 90, 'left': 80 },
                        xScale={
                            'type': 'point',
                            'min': 'auto',
                            'max': 'auto',
                            'stacked': False,
                            'reverse': False
                        },
                        yScale={
                            'type': 'linear',
                            'min': 'auto',
                            'max': 'auto',
                            'stacked': True,
                            'reverse': False
                        },
                        yFormat=" >-,.2~d",
                        axisTop=None,
                        axisRight=None,
                        axisBottom={
                            'tickSize': 1,
                            'tickPadding': 1,
                            'tickRotation': -70,
                            'legend': 'æ—¥ä»˜',
                            'legendOffset': 80,
                            'legendPosition': 'middle'
                        },
                        axisLeft={
                            'tickSize': 3,
                            'tickPadding': 3,
                            'tickRotation': 0,
                            'legend': 'count',
                            'legendOffset': -75,
                            'legendPosition': 'middle'
                        },
                        enableGridX=False,
                        enableGridY=False,
                        enablePoints=False,
                        pointSize=2,
                        pointColor={ 'theme': 'background' },
                        pointBorderWidth=1,
                        pointBorderColor={ 'from': 'serieColor' },
                        pointLabelYOffset=-7,
                        useMesh=True,
                        # -- å‡¡ä¾‹ã®è¨­å®š -- #
                        legends=[
                            {
                                'anchor': 'top-left',
                                'direction': 'column',
                                'justify': False,
                                'translateX': 15,
                                'translateY': 0,
                                'itemsSpacing': 0,
                                'itemDirection': 'left-to-right',
                                'itemWidth': 80,
                                'itemHeight': 10,
                                'itemOpacity': 0.75,
                                'symbolSize': 7,
                                'symbolShape': 'circle',
                                'symbolBorderColor': 'rgba(0, 0, 0, .5)',
                                'effects': [
                                    {
                                        'on': 'hover',
                                        'style': {
                                            'itemBackground': 'rgba(0, 0, 0, .03)',
                                            'itemOpacity': 1
                                        }
                                    }
                                ]
                            }
                        ]
                    )

### ----- Graph Visualizationï¼ˆã‚°ãƒ©ãƒ•ã®å¯è¦–åŒ–ï¼‰ ----- ###
with elements("dashboard"):
    # default layout settingï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®è¨­å®šï¼‰
    layout = [
        # Parameters: element_identifier, x_pos, y_pos, width, height, [item properties...]
        dashboard.Item("confirmed_chart", 0, 0, 6, 3.5),
        dashboard.Item("deceased_chart", 6, 0, 6, 3.5),
        dashboard.Item("male_pupulation_chart", 0, 0, 6, 3.5),
        dashboard.Item("female_pupulation_chart", 6, 0, 6, 3.5),
    ]

    # IF check box is ON, show graph.ï¼ˆã‚µã‚¤ãƒ‰ãƒãƒ¼ã§ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒONã«ãªã£ã¦ã„ã‚‹å ´åˆã®ã¿ã‚°ãƒ©ãƒ•ã‚’è¡¨ç¤ºï¼‰
    with dashboard.Grid(layout, draggableHandle=".draggable"):
        if is_graph_active_confirmed:
            dataset_graph_confirmed = create_data(y_data='cumulative_confirmed')
            create_chart(KEYNAME="confirmed_chart", CARD_TITLE="Confirmed Chart", INPUT_DATA=dataset_graph_confirmed)

        if is_graph_active_deceased:
            dataset_graph_deceased = create_data(y_data='cumulative_deceased')
            create_chart(KEYNAME="deceased_chart", CARD_TITLE="Deceased Chart", INPUT_DATA=dataset_graph_deceased)


        if is_graph_active_male_pupulation:
            dataset_graph_population_male = create_data(y_data='population_male')
            create_chart(KEYNAME="male_pupulation_chart", CARD_TITLE="Male Pupulation Chart", INPUT_DATA=dataset_graph_population_male)

        if is_graph_active_female_pupulation:
            dataset_graph_population_female = create_data(y_data='population_female')
            create_chart(KEYNAME="female_pupulation_chart", CARD_TITLE="Female Pupulation Chart", INPUT_DATA=dataset_graph_population_female)


### ----- Table Visualizationï¼ˆè¡¨ã®å¯è¦–åŒ–ï¼‰ -----  ###
## Check box what index to show(Table)
if is_table_active:
    ## Show result as a table with scroll bar.
    st.dataframe(df_dataset_table[df_dataset_table['prefecture_name'].isin(prefecture_name)].groupby(['date']).sum()[column_list].T)


## ----- SQL Editorï¼ˆSQLã‚¨ãƒ‡ã‚£ã‚¿ã®ä½œæˆï¼‰ ----- ##
conn = sqlite3.connect('data.db')
conn.commit()
df_dataset_table.to_sql('my_table', conn, if_exists='replace', index=False)

sql_editor_md = """
## SQL Editor
You can use SQL Editor.

Sample Query:
```sql
select * from my_table;
``` ``` â† å®Ÿè£…æ™‚ã¯ã€Œ```ã€ã®ã¿ã¨ã—ã¦ãã ã•ã„mm
### â†“Enter your SQL query below
"""
st.markdown(sql_editor_md)
query = st.text_input('â€»Table Name is `my_table`')
if query:
    results = pd.read_sql_query(query, conn)
    st.write(results)
```
:::

## ã‚³ãƒ¼ãƒ‰ã®è§£èª¬
ã‚³ãƒ¼ãƒ‰ã¨UIã®å¯¾å¿œã«ã¤ã„ã¦ç”»åƒã‚’äº¤ãˆã¦èª¬æ˜ã—ã¾ã™ã€‚

### ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆãƒ‡ãƒ¼ã‚¿ã®é›†è¨ˆå¯¾è±¡ã‚’çµã‚Šè¾¼ã‚€ï¼‰
ä»Šå›ã®å®Ÿè£…ã§ã¯ã€ã‚µã‚¤ãƒ‰ãƒãƒ¼ã§é¸æŠã—ãŸé …ç›®ã§ãƒ‡ãƒ¼ã‚¿ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚’è¡Œã†æ–¹é‡ã¨ã—ã¦ã„ã¾ã™ã€‚
å¾Œã®ã‚³ãƒ¼ãƒ‰ã«ã¦ã€é¸æŠã•ã‚ŒãŸå€¤ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ã‹ã‘ã¦ã„ã¾ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/a0b02ff7a035-20231208.gif)*ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆéƒ½é“åºœçœŒã¨æœŸé–“ã®æŒ‡å®šï¼‰*
```py
## ----- Sidebarï¼ˆã‚µã‚¤ãƒ‰ãƒãƒ¼ã®è¨­å®šï¼‰ ----- ##
## --- Input boxï¼ˆãƒ‡ãƒ¼ã‚¿çµã‚Šè¾¼ã¿ç”¨ã®å…¥åŠ›æ¬„ã®ä½œæˆï¼‰ --- ##
## Input box of prefecture_nameï¼ˆè¤‡æ•°éƒ½é“åºœçœŒã§çµã‚Šè¾¼ã¿ã‚’è¡Œã†ãŸã‚ã®å…¥åŠ›Boxã®ä½œæˆï¼‰
prefecture_name = st.sidebar.multiselect(
    'Prefecutre Name'
    , prefecture_name_list
    , default=['Tokyo']
    )

## Input box of Start dayï¼ˆé›†è¨ˆæœŸé–“ã®èµ·ç‚¹ã¨ãªã‚‹æ—¥ä»˜ï¼‰
start_date = pd.to_datetime(st.sidebar.date_input('Start date', datetime(2020, 3, 1)))

## Input box of End dayï¼ˆé›†è¨ˆæœŸé–“ã®çµ‚ç‚¹ã¨ãªã‚‹æ—¥ä»˜ï¼‰
end_date = pd.to_datetime(st.sidebar.date_input('End date', datetime(2021, 12, 31)))
st.sidebar.write('------------------')
```

### ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆã‚°ãƒ©ãƒ•ãƒ»è¡¨ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’å‡ºã—åˆ†ã‘ã‚‹ï¼‰
ç¶šã„ã¦ã‚°ãƒ©ãƒ•ãƒ»è¡¨ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’å‡ºã—åˆ†ã‘ã‚‹ãŸã‚ã«ã€ã‚µã‚¤ãƒ‰ãƒãƒ¼ã«ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚ã“ã¡ã‚‰ã‚‚å¾Œã®ã‚³ãƒ¼ãƒ‰ã«ã¦ã€ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’å…¥åŠ›ã•ã‚Œã¦å¾—ã‚‰ã‚ŒãŸtrue/falseã®å€¤ã‚’å…ƒã«ã€è¡¨ç¤º/éè¡¨ç¤ºã‚’å‡ºã—åˆ†ã‘ã‚‹ã‚ˆã†å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚

#### ã‚°ãƒ©ãƒ•ã®è¡¨ç¤º/éè¡¨ç¤ºã®å‡ºã—åˆ†ã‘
![](https://storage.googleapis.com/zenn-user-upload/b55c5971d860-20231208.gif)*ã‚°ãƒ©ãƒ•ã®è¡¨ç¤º/éè¡¨ç¤ºã®å‡ºã—åˆ†ã‘*
```py
## --- Check boxï¼ˆã‚°ãƒ©ãƒ•ãƒ»è¡¨ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’å‡ºã—åˆ†ã‘ã‚‹ãŸã‚ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ä½œæˆï¼‰ --- ##
st.sidebar.write('Graph Check Box')
is_graph_active_confirmed = st.sidebar.checkbox('Show Confirmed Graph', value=True)
is_graph_active_deceased = st.sidebar.checkbox('Show Deceased Graph', value=True)
# is_graph_active_recovered = st.sidebar.checkbox('Show Recovered Graph', value=True)
# is_graph_active_pupulation = st.sidebar.checkbox('Show Pupulation Graph', value=True)
is_graph_active_male_pupulation = st.sidebar.checkbox('Show Male Pupulation Graph', value=True)
is_graph_active_female_pupulation = st.sidebar.checkbox('Show Female Pupulation Graph', value=True)
```

#### è¡¨ã®è¡¨ç¤º/éè¡¨ç¤ºã®å‡ºã—åˆ†ã‘
[](https://storage.googleapis.com/zenn-user-upload/48a14ee8e76a-20231208.gif)*è¡¨ã®è¡¨ç¤º/éè¡¨ç¤ºã®å‡ºã—åˆ†ã‘*
```py!
st.sidebar.write('------------------')
st.sidebar.write('Table Column Check Box')
is_table_active = st.sidebar.checkbox('Show Table', value=True)
column_list = st.sidebar.multiselect(
    'Show Table'
    , column_list
    , default=['country_name', 'prefecture_name', 'population', 'population_male', 'population_female', 'cumulative_confirmed', 'cumulative_deceased', 'cumulative_recovered']
    )
```

### ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®åŠ å·¥
pandasã‚’ç”¨ã„ã¦ã€ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®åŠ å·¥ãƒ»çµã‚Šè¾¼ã¿ã‚’è¡Œã„ã¾ã™ã€‚
`prefecture_name`, `start_date`, `end_date`ã¯ã€å‰è¿°ã®ã‚µã‚¤ãƒ‰ãƒãƒ¼ã§å…¥åŠ›ã•ã‚ŒãŸå¤‰æ•°ãŒå…¥ã‚Šã¾ã™ã€‚
```py
## -------- Dataset processingï¼ˆãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®åŠ å·¥ãƒ»çµã‚Šè¾¼ã¿ï¼‰ -------- ##
df_dataset['date'] = pd.to_datetime(df_dataset['date'])
# Filter dataset by first day of monthï¼ˆæœˆåˆæ—¥ã®ã¿æŠ½å‡ºï¼‰
df_dataset = df_dataset[(df_dataset['date'].dt.day == 1)]
## Filter dataset by selected prefecture_name&termï¼ˆã‚µã‚¤ãƒ‰ãƒãƒ¼ã§é¸æŠã•ã‚ŒãŸéƒ½é“åºœçœŒãƒ»é›†è¨ˆæœŸé–“ã«çµã‚Šè¾¼ã¿ï¼‰
df_dataset = df_dataset[(df_dataset['prefecture_name'].isin(prefecture_name)) & (df_dataset['date'] >= start_date) & (df_dataset['date'] <= end_date)]
# Change date type to strï¼ˆæ—¥ä»˜å‹ã ã¨æƒ³å®šé€šã‚Šã®å¯è¦–åŒ–ãŒã§ããªã‹ã£ãŸãŸã‚ã€æ–‡å­—åˆ—å‹ã«å¤‰æ›ï¼‰
df_dataset['date'] = df_dataset['date'].astype(str)

## duplicate dataset 1.for graph, 2.for table
df_dataset_graph = df_dataset.copy()
df_dataset_table = df_dataset.copy()
```


### ã‚°ãƒ©ãƒ•ã®å¯è¦–åŒ–ã‚’è¡Œã†ãŸã‚ã®è¨­å®š

ä»Šå›ã¯ãƒ‰ãƒ©ãƒƒã‚°ãƒ»ã‚µã‚¤ã‚ºå¤‰æ›´å¯èƒ½ãªã‚°ãƒ©ãƒ•ã‚’ä½œæˆã—ãŸã‹ã£ãŸãŸã‚ã€[streamlit-elements](https://github.com/okld/streamlit-elements)ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚
ç¾çŠ¶ã®streamlit-elementsã§ã¯ã€Reactã®ãƒãƒ£ãƒ¼ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã‚ã‚‹[nivo](https://nivo.rocks/about/)ãŒæ¡ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚
â€»ç¾çŠ¶ã®streamlit-elementsã§ã¯ã€streamlitæ¨™æº–ã®ãƒãƒ£ãƒ¼ãƒˆã‚’ãƒ‰ãƒ©ãƒƒã‚°ãƒ»ã‚µã‚¤ã‚ºå¤‰æ›´å¯èƒ½ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«å¤‰æ›´ã™ã‚‹ã“ã¨ã¯ã§ããªã„ã‚ˆã†ã§ã—ãŸã€‚

ã—ãŸãŒã£ã¦ã€nivoã§å¿…è¦ã¨ã•ã‚Œã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¸ã®ä¿®æ­£ã¨ãƒãƒ£ãƒ¼ãƒˆã®è¨­å®šã‚’ã“ã“ã§è¡Œã„ã¾ã™ã€‚ï¼ˆè¨­å®šã«ã¤ã„ã¦ã¯ã€[Line chart | nivo](https://nivo.rocks/line/)ã‚’ã”è¦§ãã ã•ã„ã€‚ï¼‰

:::details ã‚³ãƒ¼ãƒ‰(é•·ã„ãŸã‚æŠ˜ã‚ŠãŸãŸã‚“ã§ã„ã¾ã™ï¼‰
```py
### -------- Graph Visualization settingï¼ˆã‚°ãƒ©ãƒ•ã®å¯è¦–åŒ–ã‚’è¡Œã†ãŸã‚ã®è¨­å®šï¼‰ -------- ###
tmp = df_dataset_graph.groupby(['date']).sum()[['cumulative_confirmed']]
tmp['date'] = tmp.index
tmp = tmp.rename(columns={'date': 'x', 'cumulative_confirmed': 'y'})[['x', 'y']].to_json(orient='records')
tmp_data = [
        {
            "id": prefecture_name,
            "data": eval(tmp)
        }
    ]

## If you want to show detail data, you can use this code.
# st.write(tmp_data)

def create_data(y_data):
    tmp = df_dataset_graph.groupby(['date']).sum()[[y_data]]
    tmp['date'] = tmp.index
    tmp = tmp.rename(columns={'date': 'x', y_data: 'y'})[['x', 'y']].to_json(orient='records')
    return [
                {
                    "id": "+".join(prefecture_name),
                    "data": eval(tmp)
                }
            ]

def create_chart(KEYNAME, CARD_TITLE, INPUT_DATA):
    with mui.Card(key=KEYNAME, sx={"display": "flex", "flexDirection": "column"}):
                mui.CardHeader(title=CARD_TITLE, className="draggable")
                with mui.CardContent(sx={"flex": 1, "minHeight": 0}):
                    nivo.Line(
                        data=INPUT_DATA,
                        margin={ 'top': 10, 'right': 80, 'bottom': 90, 'left': 80 },
                        xScale={
                            'type': 'point',
                            'min': 'auto',
                            'max': 'auto',
                            'stacked': False,
                            'reverse': False
                        },
                        yScale={
                            'type': 'linear',
                            'min': 'auto',
                            'max': 'auto',
                            'stacked': True,
                            'reverse': False
                        },
                        yFormat=" >-,.2~d",
                        axisTop=None,
                        axisRight=None,
                        axisBottom={
                            'tickSize': 1,
                            'tickPadding': 1,
                            'tickRotation': -70,
                            'legend': 'æ—¥ä»˜',
                            'legendOffset': 80,
                            'legendPosition': 'middle'
                        },
                        axisLeft={
                            'tickSize': 3,
                            'tickPadding': 3,
                            'tickRotation': 0,
                            'legend': 'count',
                            'legendOffset': -75,
                            'legendPosition': 'middle'
                        },
                        enableGridX=False,
                        enableGridY=False,
                        enablePoints=False,
                        pointSize=2,
                        pointColor={ 'theme': 'background' },
                        pointBorderWidth=1,
                        pointBorderColor={ 'from': 'serieColor' },
                        pointLabelYOffset=-7,
                        useMesh=True,
                        # -- å‡¡ä¾‹ã®è¨­å®š -- #
                        legends=[
                            {
                                'anchor': 'top-left',
                                'direction': 'column',
                                'justify': False,
                                'translateX': 15,
                                'translateY': 0,
                                'itemsSpacing': 0,
                                'itemDirection': 'left-to-right',
                                'itemWidth': 80,
                                'itemHeight': 10,
                                'itemOpacity': 0.75,
                                'symbolSize': 7,
                                'symbolShape': 'circle',
                                'symbolBorderColor': 'rgba(0, 0, 0, .5)',
                                'effects': [
                                    {
                                        'on': 'hover',
                                        'style': {
                                            'itemBackground': 'rgba(0, 0, 0, .03)',
                                            'itemOpacity': 1
                                        }
                                    }
                                ]
                            }
                        ]
                    )
```
:::

### è¡¨ã®å¯è¦–åŒ–
ã‚µã‚¤ãƒ‰ãƒãƒ¼ã§è¨­å®šã—ãŸå†…å®¹ã‚’ã‚‚ã¨ã«è¡¨ã®è¡¨ç¤º/éè¡¨ç¤ºãƒ»è¡¨ç¤ºã™ã‚‹è¡Œã®çµã‚Šè¾¼ã¿ã‚’è¡Œã„ã¾ã™ã€‚
```py
### ----- Table Visualizationï¼ˆè¡¨ã®å¯è¦–åŒ–ï¼‰ -----  ###
## Check box what index to show(Table)
if is_table_active:
    ## Show result as a table with scroll bar.
    st.dataframe(df_dataset_table[df_dataset_table['prefecture_name'].isin(prefecture_name)].groupby(['date']).sum()[column_list].T)
```

### SQLã‚¨ãƒ‡ã‚£ã‚¿ã®ä½œæˆ
Streamlitã§ã¯BigQueryã‚„Snowflakeã®ã‚ˆã†ãªSQLã‚¨ãƒ‡ã‚£ã‚¿ã‚’ã€GUIä¸Šã«è¨­å®šã™ã‚‹ã“ã¨ã‚‚ã§ãã‚‹ã‚ˆã†ã§ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/1f8207fee38a-20231208.png)*SQLã‚¨ãƒ‡ã‚£ã‚¿*

```py
## ----- SQL Editorï¼ˆSQLã‚¨ãƒ‡ã‚£ã‚¿ã®ä½œæˆï¼‰ ----- ##
conn = sqlite3.connect('data.db')
conn.commit()
df_dataset_table.to_sql('my_table', conn, if_exists='replace', index=False)

sql_editor_md = """
## SQL Editor
You can use SQL Editor.

Sample Query:
```sql
select * from my_table;
``` ``` â† å®Ÿè£…æ™‚ã¯ã€Œ```ã€ã®ã¿ã¨ã—ã¦ãã ã•ã„mm
### â†“Enter your SQL query below
"""
st.markdown(sql_editor_md)
query = st.text_input('â€»Table Name is `my_table`')
if query:
    results = pd.read_sql_query(query, conn)
    st.write(results)
```


# æ‰€æ„Ÿ

Streamlit(+nivo)ã‚’ç”¨ã„ã‚‹ã“ã¨ã§ã€BIãƒ„ãƒ¼ãƒ«ã®ã‚ˆã†ã«åˆ©ç”¨è€…ãŒã‚°ãƒ©ãƒ•ã‚„è¡¨ã®ãƒ‰ãƒ©ãƒƒã‚°ã€ã‚µã‚¤ã‚ºå¤‰æ›´ã€è¡¨ç¤º/éè¡¨ç¤ºã®åˆ‡ã‚Šæ›¿ãˆã‚’è¡Œãˆã‚‹ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’ä½œæˆã§ãã¾ã—ãŸã€‚
ä»Šå›ã®å®Ÿè£…ã ã¨ã€ãƒ‡ãƒ¼ã‚¿å¯è¦–åŒ–ã®éƒ¨åˆ†ã¯streamlitã§ã¯ãªãReactã®ãƒãƒ£ãƒ¼ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã‚ã‚‹nivoã«ä¾å­˜ã—ã¦ã„ã‚‹ãŸã‚ã€ã¨ã£ã¤ãã«ãã•ã‚„ä¿å®ˆãƒ»é‹ç”¨è¦³ç‚¹ã§ã®èª²é¡ŒãŒã‚ã‚Šãã†ã¨æ„Ÿã˜ã¾ã—ãŸã€‚

ä»–ã®ã‚‚ã£ã¨ã„ã„æ‰‹æ®µã‚’ã”å­˜çŸ¥ã®æ–¹ã„ã‚Œã°ã€ãœã²ãœã²ã‚³ãƒ¡ãƒ³ãƒˆã€DMã„ãŸã ã‘ã‚‹ã¨å¬‰ã—ã„ã§ã™ï¼